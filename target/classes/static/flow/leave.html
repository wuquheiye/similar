<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>请假申请</title>
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../bootstrop/css/bootstrap.css">
    <link rel="stylesheet" href="../use/css/common.css">

    <link rel="stylesheet" href="../use/css/bootstrap-material-datetimepicker.css" />
    <link rel="stylesheet" type="text/css" href="../use/css/default.css">
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="../bootstrop/js/bootstrap.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <!--日期控件-->
    <script type="text/javascript" src="../use/js/moment-with-locales.min.js"></script>
    <script type="text/javascript" src="../use/js/bootstrap-material-datetimepicker.js"></script>

    <!--    全局配置文件-->
    <script type="text/javascript" src="../myjs/httpData.config.js"></script>

</head>
<body>
    <div class="container-fluid">
        <!--头部-->
        <div class="container navbar-fixed-top" style="background: white">
            <div class="row">
                <div class="col-xs-2">
                    <a href="/use/index.html?publicBottomImages=publicBottomInformation"><h4><span class="glyphicon glyphicon-menu-left"
                                                                 aria-hidden="true"></span></h4></a>
                </div>
                <div class="col-xs-8" style="text-align: center">
                    <h4><b id="title">请假申请</b></h4></div>
            </div>
        </div>
        <div class="container" style="padding-top: 55px">
            <div class="row">
                <div class="col-xs-12">
                    流程标题
                </div>
                <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 90%;background: #F4F4F4;margin: auto">
                <div class="col-xs-12" style="padding-top: 10px">
                    <span  id="otTitle"></span>
                </div>
            </div>
        </div>
        <hr style="margin-top: 10px;margin-bottom: 10px;height:10px;width: 100%;background: #F4F4F4">
        <div class="container">
            <div class="row">
                <div class="col-xs-6">
                    部门
                </div>
                <div class="col-xs-6">
                    <div>
                        <span style="width: 85px;
                        border-radius: 30px;
                        background: ghostwhite;
                        text-align: center;
                        float: right;" id="otSection"></span>
                        </div>
                </div>
            </div>
            <hr style="margin-top: 10px;margin-bottom: 10px;height:10px;width: 100%;background: #F4F4F4">
        </div>
        <div class="container">
            <div class="row">
                <div class="col-xs-6">
                    请假人
                </div>
                <div class="col-xs-6">
                    <div>
                        <span style="width: 85px;
                        border-radius: 30px;
                        background: ghostwhite;
                        text-align: center;
                        float: right;" id="otName">貂蝉</span>
                    </div>
                </div>
            </div>
            <hr style="margin-top: 10px;margin-bottom: 10px;height:10px;width: 100%;background: #F4F4F4">
        </div>
        <div class="container">
            <div class="row">
                <div class="col-xs-6">
                    申请日期
                </div>
                <div class="col-xs-6">
                    <span style="float: right;text-align: right" id="defuletTime"></span>
                </div>
            </div>
            <hr style="margin-top: 10px;margin-bottom: 10px;height:10px;width: 100%;background: #F4F4F4">
        </div>
        <!--假期-->
        <div class="container">
            <div class="row" style="height: 35px">
                <div class="col-xs-6" style="line-height: 35px">
                    <span style="color: red;">*</span>休假类型
                </div>
                <div class="col-xs-6" >
                    <select class="form-control" style="border: 0px" id="fleaveType">
                        <option>请选择休假类型</option>
                        <option value="0">年假</option>
                        <option value="1">事假</option>
                        <option value="2">病假</option>
                        <option value="3">婚假</option>
                        <option value="4">产假及哺乳假</option>
                        <option value="5">陪产假</option>
                        <option value="6">丧家</option>
                        <option value="7">调休假</option>
                    </select>
                </div>
            </div>
            <hr style="margin-top: 10px;margin-bottom: 10px;height:10px;width: 100%;background: #F4F4F4">
        </div>

        <!--请假info-->
        <div class="container">
<!--            <div class="row" style="height: 35px">-->
<!--                <div class="col-xs-6" style="line-height: 30px">-->
<!--                    累计已休-->
<!--                </div>-->
<!--                <div class="col-xs-6" style="text-align: right;line-height: 30px">-->
<!--                    3天-->
<!--                </div>-->
<!--            </div>-->
<!--            <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 90%;background: #F4F4F4;margin: auto">-->
            <div class="row" style="height: 35px">
                <div class="col-xs-6" style="line-height: 30px">
                    请假开始
                </div>
                <div class="col-xs-6" style="line-height: 30px;padding-left: 0px">
                    <input type="text" id="date-start" style="width: 100%;direction: rtl;border: 0px;outline:medium;" class="form-control floating-label" placeholder="Date" >
                </div>
            </div>
            <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 90%;background: #F4F4F4;margin: auto">
            <div class="row" style="height: 35px">
                <div class="col-xs-6" style="line-height: 30px">
                    请假结束
                </div>
                <div class="col-xs-6" style="line-height: 30px;padding-left: 0px">
                    <input type="text" id="date-end" style="width: 100%;direction: rtl;border: 0px;outline:medium;" class="form-control floating-label" placeholder="Date" >
                </div>
            </div>
            <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 90%;background: #F4F4F4;margin: auto">
            <div class="row" style="height: 35px">
                <div class="col-xs-6" style="line-height: 30px">
                    请假时长
                </div>
                <div class="col-xs-6" style="line-height: 30px;padding-left: 0px;text-align: right" id="duration">
                </div>
            </div>
            <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 90%;background: #F4F4F4;margin: auto">
            <div class="row" >
                <div class="col-xs-6" style="line-height: 30px">
                    请假事由
                </div>
                <div class="col-xs-12" style="height: 130px;padding: 0px">
                    <textarea class="form-control" style="height: 120px" id="fapplyReason"></textarea>
                </div>
            </div>
            <hr style="margin-top: 10px;margin-bottom: 10px;height:10px;width: 100%;background: #F4F4F4;margin: auto">
        </div>
        <!--历史休假信息-->
<!--        <div class="container" >-->
<!--            <div class="row" style="height: 150px">-->
<!--                <div class="col-xs-12" style="line-height: 35px">-->
<!--                    历史休假信息-->
<!--                </div>-->
<!--                <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 100%;background: #F4F4F4;margin: auto">-->
<!--                <div class="col-xs-12" id="history_flow" style="height:100px;-->
<!--                                      position: relative;-->
<!--                                      overflow-y:scroll; overflow-x: hidden;">-->
<!--&lt;!&ndash;                    <div class="row" style="height: 30px">&ndash;&gt;-->
<!--&lt;!&ndash;                        <div class="col-xs-6" style="line-height: 30px;">事假</div>&ndash;&gt;-->
<!--&lt;!&ndash;                        <div class="col-xs-6" style="line-height: 30px;text-align: right">&ndash;&gt;-->
<!--&lt;!&ndash;                            2019-10-06&ndash;&gt;-->
<!--&lt;!&ndash;                        </div>&ndash;&gt;-->
<!--&lt;!&ndash;                    </div>&ndash;&gt;-->
<!--&lt;!&ndash;                    <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 90%;background: #F4F4F4;margin: auto">&ndash;&gt;-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
        <!--审批-->
        <div class="container" style="padding-bottom: 70px">
<!--            <div class="row">-->
<!--                <div class="col-xs-6">-->
<!--                    部门主管审批-->
<!--                </div>-->
<!--                <div class="col-xs-6">-->

<!--                </div>-->
<!--            </div>-->
<!--            <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 90%;background: #F4F4F4;margin: auto">-->
            <div class="row" style="line-height: 35px">
                <div class="col-xs-12" style="line-height: 35px">
                    将申请推送给领导审批
                </div>
                <div class="col-xs-12" style="line-height: 35px">
                    <select class="form-control" id="fuidManager" style="border: 0px">

                    </select>
                </div>
            </div>
        </div>
        <!--底部-->
        <div class="container navbar-fixed-bottom" >
            <button type="button" class="btn btn-primary btn-lg btn-block" onclick="commitflow()">提交流程</button>
        </div>
    </div>
</body>

<script>
    //缓存获取当前用户信息 , 并得到他的角色 loginObj.users.uid
    var loginObj = JSON.parse(window.sessionStorage.getItem("login"));

    $(function () {
        $("#otTitle").text(loginObj.users.uusername+"_加班");
        $("#otSection").text(loginObj.department.dname);
        $("#otName").text(loginObj.users.uusername);
        $("#defuletTime").text(getCurrentDate());
        //获取选择时间
        // $("#duration").text("");
        // selectLeaveAll();
        selectusersbyrid()
    })

    /**
     * 获取全部经理和利捷总经理
     */
    function selectusersbyrid() {
        $.ajax({
            url: pageDesignControl_HOST + "manage/users/selectusersbyrid",
            type: "get",
            dataType: "json",
            // data: JSON.stringify(leaveflow),
            contentType: 'application/json; charset=UTF-8',
            async: false,
            success: function (res) {
                let showdata='';
                showdata+='<option value="0">选择推送领导</option>\n' ;
                if(res.msg!=""){
                    $.each(res.msg,function (index,value) {
                        showdata+=' <option value="'+value.uid+'">'+value.uusername+'</option>';
                    })
                }
                $("#fuidManager").html(showdata);
            },
            error:function () {
                alert("网络异常")
            }
        })
    }


    /**
     *  获取历史申请记录
     */
    function selectLeaveAll() {
        let showdata='';
        $.ajax({
            url: pageDesignControl_HOST + "flow/selectLeaveAll?uid="+loginObj.users.uid+"&ftype="+ftypeFlow.LEAVE.code,
            type: "get",
            dataType: "json",
            contentType: 'application/json; charset=UTF-8',
            async: false,
            success: function(res) {
                if(res.msg!=null){
                    $.each(res.msg,function (index,value) {
                        showdata+='<div class="row" style="height: 30px">\n' +
                            '                        <div class="col-xs-6" style="line-height: 30px;">事假</div>\n' +
                            '                        <div class="col-xs-6" style="line-height: 30px;text-align: right">\n' +
                                                value.fapplyTime+
                            '                        </div>\n' +
                            '                    </div>\n' +
                            '                    <hr style="margin-top: 10px;margin-bottom: 10px;height:1px;width: 90%;background: #F4F4F4;margin: auto">';
                    })
                    $("#history_flow").html(showdata);
                }else{
                    alert("申请发出失败");
                }
            },
            error: function(){
                alert("网络信号不好，请重试");
            }

        })
    }


    /**
     * 录入请假申请
     */
    function commitflow() {
        let ftype= ftypeFlow.LEAVE.code;
        // let uid = 1;
        let fapplyTime = $("#defuletTime").text();
        let fleaveType = $("#fleaveType").val();
        let fstartTime = $("#date-start").val();
        let fendTime = $("#date-end").val();
        let fapplyReason = $("#fapplyReason").val();
        let fuidManager=$("#fuidManager").val();
        let leave={
            "ftype" : ftype,
            "uid" :loginObj.users.uid,
            "fleaveType":fleaveType,
            "fapplyTime" : fapplyTime,
            "fstartTime":fstartTime,
            "fendTime" :　fendTime,
            "fapplyReason":fapplyReason,
            "uusername":loginObj.users.uusername,
            "dname":loginObj.department.dname,
            // "fuidCharge" :loginObj.users.fuidCharge,
            "fuidManager":fuidManager,
            "fuidStaffing":roleType.ADMINISTRATIVE.code,
            // "artsVision":loginObj.department.ArtsVision
        }
        $.ajax({
                url: pageDesignControl_HOST + "flow/leaveInsert",
                type: "post",
                dataType: "json",
                data:JSON.stringify(leave),
                contentType: 'application/json; charset=UTF-8',
                async: false,
                success: function(res) {
                if(res.msg==true){
                    alert("申请已发出")
                }else{
                    alert("申请发出失败");
                }
            },
            error: function(){
                alert("网络信号不好，请重试");
            }

        })

    }
    //两个时间计算时间差
    function leadTimeTwo(s, e) {
        let databaseTime = Date.parse(getDateSprit(s));
        let date = Date.parse(getDateSprit(e));
        let lead = date - databaseTime;
        let leadDate = Math.floor(lead / 86400000) + "天";
        let leadTime = Math.floor((lead % 86400000) / (1000 * 60 * 60)) + "小时";
        return leadDate + leadTime;
    }

    //hh:mm  dd/MM/yyyy 格式字符串转日期
    function getDateSprit(strDate) {
        var st = strDate;
        var a = st.split(" ");
        var b = a[0].split("/");
        var c = a[1].split(":");
        var date = new Date(b[2], b[1], b[0], c[0], c[1]);
        return date;
    }

    $("#date-start").change(function () {
        // alert($("#date-end").val())
        if($("#date-end").val()!=''){
            // alert("val:"+$(this).val());
            let leadtime=leadTimeTwo($(this).val(),$("#date-end").val());
            $("#duration").text(leadtime);
        }

    })
    $("#date-end").change(function () {
        // alert($("#date-start").val())
        if($("#date-start").val()!=''){
            // alert("val:"+$(this).val());
            let leadtime=leadTimeTwo($("#date-start").val(),$(this).val());
            $("#duration").text(leadtime);
        }

    })




    //获取当前时间
    function getCurrentDate(){
        var timeStr = '-';
        var curDate = new Date();
        var curYear =curDate.getFullYear();  //获取完整的年份(4位,1970-????)
        var curMonth = curDate.getMonth()+1;  //获取当前月份(0-11,0代表1月)
        var curDay = curDate.getDate();       //获取当前日(1-31)
        var curWeekDay = curDate.getDay();    //获取当前星期X(0-6,0代表星期天)
        var curHour = curDate.getHours();      //获取当前小时数(0-23)
        var curMinute = curDate.getMinutes();   // 获取当前分钟数(0-59)
        var curSec =curDate.getSeconds();      //获取当前秒数(0-59)
        var Current= curYear+timeStr+curMonth+timeStr+curDay+' '+curHour+':'+curMinute;
        console.log(Current);
        // this.datetime=Current;
        return Current;
    }
    // 日期插件
    $(document).ready(function() {
        $('#date').bootstrapMaterialDatePicker({
            time: false
        });
        $('#date_end').bootstrapMaterialDatePicker({
            time: false
        });

        $('#time').bootstrapMaterialDatePicker
        ({
            date: false,
            shortTime: true,
            format: 'HH:mm'
        });

        $('#date-format').bootstrapMaterialDatePicker
        ({
            format: 'dddd DD MMMM YYYY - HH:mm'
        });
        $('#date-fr').bootstrapMaterialDatePicker
        ({
            format: 'DD/MM/YYYY HH:mm',
            lang: 'fr',
            weekStart: 1,
            cancelText : 'ANNULER'
        });

        $('#date-end').bootstrapMaterialDatePicker
        ({
            weekStart: 0, format: 'DD/MM/YYYY HH:mm'
        });
        $('#date-start').bootstrapMaterialDatePicker
        ({
            weekStart: 0, format: 'DD/MM/YYYY HH:mm'
        }).on('change', function(e, date)
        {
            $('#date-end').bootstrapMaterialDatePicker('setMinDate', date);
        });

        $('#min-date').bootstrapMaterialDatePicker({ format : 'DD/MM/YYYY HH:mm', minDate : new Date() });

        // $.material.init()
    });
</script>
</html>